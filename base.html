<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>เครื่องคิดเลขเลขฐาน — ตามลำดับเครื่องหมาย</title>
<style>
body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:#f5f7fa; padding:20px; }
.calculator { max-width:850px; margin:0 auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.08); }
h1 { text-align:center; margin:0 0 15px; color:#333; }
.row { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
.col { flex:1 1 200px; min-width:200px; }
label { display:block; color:#333; margin-bottom:6px; font-weight:600; }
input[type=text] { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
.radio-group { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
.radio-group label { font-weight:500; background:#f1f1f1; padding:6px 10px; border-radius:6px; cursor:pointer; display:flex; align-items:center; }
.radio-group input { margin-right:5px; }
.radio-group input:checked + span { font-weight:bold; color:#007bff; }
.buttons { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
button { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-size:15px; }
.btn-primary { background:#007bff; color:white; }
.btn-clear { background:#dc3545; color:white; }
.btn-copy { background:#28a745; color:white; }
.result-box { margin-top:14px; display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.result-item { background:#f1fbf6; padding:10px; border-radius:6px; font-weight:600; }
.steps { margin-top:20px; }
.step-section { margin-bottom:16px; background:#fbfbff; padding:12px; border-radius:8px; border:1px solid #eef; font-family:monospace; white-space:pre-wrap; }
.step-section h3 { margin-top:0; font-size:16px; background:#eef; padding:6px 8px; border-radius:6px; }
.error { color:#b00; margin-top:10px; }
@media (max-width:640px){ .result-box { grid-template-columns:1fr; } .row{flex-direction:column} }
</style>
</head>
<body>
<div class="calculator">
<h1>เครื่องคิดเลขเลขฐาน (ลำดับเครื่องหมาย)</h1>

<div class="row">
<div class="col">
<label>เลือกเลขฐาน:</label>
<div class="radio-group" id="base-options">
<label><input type="radio" name="base" value="2"><span>ฐาน 2</span></label>
<label><input type="radio" name="base" value="8"><span>ฐาน 8</span></label>
<label><input type="radio" name="base" value="10" checked><span>ฐาน 10</span></label>
<label><input type="radio" name="base" value="16"><span>ฐาน 16</span></label>
</div>
</div>

<div class="col">
<label for="expression">ป้อนสมการ (เช่น 10+2*3-4/2)</label>
<input id="expression" type="text" placeholder="เช่น 10+2*3-4/2">
</div>
</div>

<div class="buttons">
<button class="btn-primary" onclick="calculateExpression()">คำนวณและแสดงขั้นตอน</button>
<button class="btn-clear" onclick="clearAll()">เคลียร์</button>
<button class="btn-copy" onclick="copyResults()">คัดลอกผลลัพธ์</button>
</div>

<div class="result-box" id="results">
<div class="result-item" id="result-b2">ฐาน 2: ---</div>
<div class="result-item" id="result-b8">ฐาน 8: ---</div>
<div class="result-item" id="result-b10">ฐาน 10: ---</div>
<div class="result-item" id="result-b16">ฐาน 16: ---</div>
</div>

<div id="steps" class="steps"></div>
<div id="error-message" class="error"></div>
</div>

<script>
function getSelectedBase() {
    const radios = document.querySelectorAll('input[name="base"]');
    for (const r of radios) if (r.checked) return parseInt(r.value);
    return 10;
}

// ฟังก์ชันหลักคำนวณ
function calculateExpression() {
    const expr = document.getElementById("expression").value.trim();
    const base = getSelectedBase();
    const errorEl = document.getElementById("error-message");
    const stepsEl = document.getElementById("steps");
    errorEl.innerText = "";
    stepsEl.innerHTML = "";

    if (!expr.match(/^[0-9A-F+\-*/]+$/i)) {
        errorEl.innerText = "กรุณาป้อนสมการให้ถูกต้อง";
        return;
    }

    // แยกตัวเลขและเครื่องหมาย
    const tokens = expr.match(/[0-9A-F]+|[+\-*/]/gi);
    if (!tokens) { errorEl.innerText = "รูปแบบสมการไม่ถูกต้อง"; return; }

    // แปลงตัวเลขทั้งหมดเป็นฐาน 10
    const values = tokens.map(t => /^[+\-*/]$/.test(t) ? t : parseInt(t, base));

    // คำนวณตามลำดับความสำคัญ *,/ ก่อน +,-
    let stepsDetail = [];
    let tempTokens = [...values];

    const opsPriority = [["*","/"], ["+","-"]];

    opsPriority.forEach(priority => {
        let i = 0;
        while (i < tempTokens.length) {
            const t = tempTokens[i];
            if (priority.includes(t)) {
                const a = tempTokens[i-1];
                const op = t;
                const b = tempTokens[i+1];
                let res;
                switch(op){
                    case "*": res = a*b; break;
                    case "/": res = Math.floor(a/b); break;
                    case "+": res = a+b; break;
                    case "-": res = a-b; break;
                }
                stepsDetail.push(`${a} ${op} ${b} = ${res}`);
                tempTokens.splice(i-1,3,res);
                i--; // ลด index เพื่อเช็คตัวถัดไป
            } else {
                i++;
            }
        }
    });

    const finalResult = tempTokens[0];

    // แสดงผลลัพธ์ทุกฐาน
    document.getElementById("result-b2").innerText  = "ฐาน 2: " + finalResult.toString(2);
    document.getElementById("result-b8").innerText  = "ฐาน 8: " + finalResult.toString(8);
    document.getElementById("result-b10").innerText = "ฐาน 10: " + finalResult.toString(10);
    document.getElementById("result-b16").innerText = "ฐาน 16: " + finalResult.toString(16).toUpperCase();

    // แสดงขั้นตอนในทุกฐาน
    [2,8,10,16].forEach(b=>showStepsBase(b,tokens,stepsDetail,base,finalResult));
}

// แสดงขั้นตอนการคำนวณในแต่ละฐาน
function showStepsBase(displayBase,tokens,stepsDetail,inputBase,finalResult){
    const stepsEl = document.getElementById("steps");
    const div = document.createElement("div");
    div.className="step-section";
    div.innerHTML=`<h3>ฐาน ${displayBase}</h3>`;

    // แสดงสมการ input ในฐานนั้น
    const exprBase = tokens.map(t=>/^[+\-*/]$/.test(t)?t:parseInt(t,inputBase).toString(displayBase).toUpperCase()).join(" ");
    div.innerHTML+=`สมการในฐาน ${displayBase}: ${exprBase}\n`;

    // แสดงทีละขั้น
    let steps="";
    stepsDetail.forEach(s=>{
        const m = s.match(/(\d+)\s*([\+\-\*\/])\s*(\d+)\s*=\s*(\d+)/);
        if(m){
            const a=parseInt(m[1],10).toString(displayBase).toUpperCase();
            const op=m[2];
            const b=parseInt(m[3],10).toString(displayBase).toUpperCase();
            const r=parseInt(m[4],10).toString(displayBase).toUpperCase();
            steps+=`${a} ${op} ${b} = ${r}\n`;
        }
    });
    steps+=`ผลลัพธ์สุดท้าย = ${finalResult.toString(displayBase).toUpperCase()}`;
    div.innerHTML+=`<pre>${steps}</pre>`;
    stepsEl.appendChild(div);
}

function clearAll(){
    document.getElementById("expression").value="";
    document.getElementById("steps").innerHTML="";
    document.getElementById("error-message").innerText="";
    ["b2","b8","b10","b16"].forEach(b=>document.getElementById("result-"+b).innerText=`ฐาน ${b.slice(1)}: ---`);
}

function copyResults(){
    const results=Array.from(document.querySelectorAll(".result-item")).map(d=>d.innerText).join("\n");
    navigator.clipboard.writeText(results);
    alert("คัดลอกผลลัพธ์แล้ว!");
}
</script>
</body>
</html>
